
var Validator = {
	/* Validator.check
	 * 概要：入力チェックをし、エラーの場合、対応したメッセージをバルーン表示する。
	 *
	 * field : 「onblur="Validator.check」が記述されているinputタグ or selectタグ
	 *
	 * reg   : 対象のフィールドの入力タイプと桁数
	 * 		   入力タイプ：(例) num, alphabet, kana
	 * 		   桁数      ：count-○（数字）count-1, count-120 などなど
	 *
	 * extra : 特にないなら、空文字でも可。(20140213 調査開始時)
	 *
	 */
   check: function(field, reg, extra) {
      var response;
      var rule = this.rule;
      rule.field = field;
      rule.value = field.value;
      rule.extra = extra;

      if(!reg || !reg.match(/^!/))
         response = rule.input();

      if(reg && !response && rule.value != '') {
    	 // 変数responseに何も代入されていない、且つ、ruleのプロパティvalueに何か値が入っていたら、regの「!」を取り除く
         reg = reg.replace(/^!/, '');

         // reg(入力タイプ + 桁数)を「入力タイプ」と「桁数」に分割して配列に格納。
         var mode = reg.split(/\s+/);
         for(var i = 0, m; m = mode[i]; i++) {
            m = m.replace(/([\d\-]+)?$/, '');
            response = rule[m](RegExp.$1);//1番目の括弧に対応する文字列
            field.value = rule.value;//全角半角の変換語のvalueを表示する。
            // responseに値が入っていたらループを抜ける
            if(response) break;
         }
      }

      // responseに値が入っていたら、バルーン表示する。
      if(response)
         this.baloon.open(field, response);
   },
   check_req: function(field) {
	      var response;
	      var rule = this.rule;
	      rule.field = field;
	      response = rule.input();
	      // responseに値が入っていたら、バルーン表示する。
	      if(response){
	         this.baloon.open(field, response);
	      }
   },
   submit: function(form) {
      this.allclose(form);
      var btns = new Array;

      for(var i = 0, f; f = form[i]; i++) {
         if(f.onblur)
            f.onblur();
         if(f.type == 'submit')
            btns.push(f);
      }

      for(var i = 0, f, z; f = form[i]; i++) {
         if(f._validbaloon && f._validbaloon.visible()) {
            while(z = btns.shift())
               this.baloon.open(z, this.rule.submit());
            return false;
         }
      }

      return true;
   },

   allclose: function(form) {
      for(var i = 0, f; f = form[i]; i++)
         if(f._validbaloon) f._validbaloon.close();
   }
};

Validator.baloon = {
   index: 0,

   open: function(field, msg) {
      if(!field._validbaloon) {
         var obj = new this.element(field);
         obj.create();
         field._validbaloon = obj;
         if(field.type == 'radio' || field.type == 'checkbox') {
            for(var i = 0, e; e = field.form[field.name][i]; i++)
               addEvent(e, 'focus', function() { obj.close(); });
         }
      }

      field._validbaloon.show(msg);
   },

   element: function() {
      this.initialize.apply(this, arguments);
   }
};

Validator.baloon.element.prototype = {
   initialize: function(field) {
      this.parent = Validator.baloon;
      this.field = field;
   },

   create: function() {
      var field  = this.field;

      var box = document.createElement('div');
      box.className = 'baloon';

      var self = this;
      addEvent(box, 'click', function() { self.toTop(); });

      var bindClose = function() { self.close(); };
      var link = document.createElement('a');
      link.appendChild(document.createTextNode('X'));
      link.setAttribute('href', 'javascript:void(0);');
      addEvent(link, 'click', bindClose);
      addEvent(field, 'focus', bindClose);

      var msg = document.createElement('span');
      var div = document.createElement('div');
      div.appendChild(link);
      div.appendChild(msg);
      box.appendChild(div);
      document.body.appendChild(box);

      this.box = box;
      this.msg = msg;
   },

   show: function(msg) {
      var field = this.field;
      this.msg.innerHTML  = msg;

      this.box.style.display = '';
      this.toTop();

      // スクロールしても変わらない値
      var offsetAbs = Position.offset(field);
      var topAbs = offsetAbs.y - 25;
      // var leftAbs = offsetAbs.x - 20 + field.offsetWidth;

      // スクロールすると変わる値
      var offsetRel = field.getBoundingClientRect();
      // var topRel = offsetRel.top - 25;;
      var LeftRel = offsetRel.left - 20 + field.offsetWidth;

      var top = topAbs;
      var left = LeftRel;

      this.box.style.top = top + 'px';
      this.box.style.left = left + 'px';

      var formWith;
      if ($("[name='cmdForm_ifream']").length > 0) {
      	formWith = $("[name='cmdForm_ifream']").width();
      } else {
      	formWith = $("[name='cmdForm']").width();
      }

      // 表示領域をはみ出す場合
      if (LeftRel + this.box.offsetWidth > formWith) {
      	this.box.style.left = offsetRel.left - this.box.offsetWidth + 20
      			+ 'px';
      	this.box.className = 'baloonR';

      } else {
      	this.box.className = 'baloon';
      }

      if(field.type != 'radio' && field.type != 'checkbox') {
         var colors = new Array('#FF6666', '#FFAAAA', '#FF6666', '#FFAAAA');
         window.setTimeout(function() {
            if(colors.length > 0) {
               field.style.backgroundColor = colors.shift();
               window.setTimeout(arguments.callee, 70);
            }
         }, 10);
      }
   },

   close: function() {
      this.box.style.display = 'none';
      this.field.style.backgroundColor = '';
   },

   visible: function() {
      return (this.box.style.display == '');
   },

   toTop: function() {
      this.box.style.zIndex = ++ this.parent.index;
   }
};

Validator.rule = {
   msg: null,

   submit: function() {
      return this.msg.submit;
   },

   input: function() {
//	   alert(this.field.name+'/'+this.field.value );
      if(this.field.type == 'radio' || this.field.type == 'checkbox') {
         for(var i = 0, e; e = this.field.form[this.field.name][i]; i++)
            if(e.checked) return;
         return this.msg.noselect;
      }else if(this.field.type == 'select-one'){
    	  if(this.field.value == '')return this.msg.noselect;
      }else {
    	  if(this.value == '')return this.msg.noinput;
      }
   },

   mail: function() {
	   this.value = toHalf(this.value);//半角変換
      if(!this.value.match(/^[\x01-\x7F]+@((([-a-z0-9]+\.)*[a-z]+)|(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}))$/))
         return this.msg.mail;
   },

   equal: function() {
      if(this.field.form[this.extra].value && this.value != this.field.form[this.extra].value)
         return this.msg.unequal;
   },

   alphabet: function() {
	   this.value = toHalf(this.value);//半角変換
     if(!this.value.match(/^[a-zA-Z\-\d]+$/))
         return this.msg.alphabet;
   },

   kana: function() {
	   this.value = toFull(this.value);//全角変換
     for(var i = 0;i < this.value.length;i++) {
//         if(this.value.charAt(i) == ' ' || this.value.charAt(i) == '\u3000') continue;
     	 if(this.value.charAt(i) > '\u30FB' && this.value.charAt(i) < '\u30FF') continue;
         if(this.value.charAt(i) < '\u30A1' || this.value.charAt(i) > '\u30F6')
            return this.msg.kana;
      }
   },

   kanas: function() {
	   this.value = toFull(this.value);//全角変換
	      for(var i = 0;i < this.value.length;i++) {
	         if(this.value.charAt(i) == '\u3000') continue;
	     	 if(this.value.charAt(i) > '\u30FB' && this.value.charAt(i) < '\u30FF') continue;
	         if(this.value.charAt(i) < '\u30A1' || this.value.charAt(i) > '\u30F6')
	            return this.msg.kana;
	      }
	   },

   zen: function() {
	   this.value = toFull(this.value);//全角変換
	   if (!this.value.match(/^[^ -~｡-ﾟ]*$/)) {
		   return this.msg.zen;
	   }
   },

   count: function(arg) {
      return this._range(arg, this.value.length, this.msg.count);
   },

   num: function(arg) {
	   this.value = toHalf(this.value);//半角変換
      if(!this.value.match(/^[\d]+$/))
         return this.msg.num.nonumber;

      return this._range(arg, parseInt(this.value), this.msg.num);
   },

   check: function(arg) {
      var value = 0;
      for(var i = 0, e; e = this.field.form[this.field.name][i]; i++)
         if(e.checked) value += 1;

      return this._range(arg, value, this.msg.check);
   },

   _range: function(range, value, msg) {
      if(!range) return;

      var result = '';
      var c = (" "+range).split(/\-/);
      var min = parseInt(c[0]) || 0;
      var max = parseInt(c[1]) || 0;

      if(value != min && /^\d+$/.test(range))
         result = msg.unequal;
      else if(min == 0 && value > max)
         result = msg.too_big;
      else if(max == 0 && value < min)
         result = msg.too_small;
      else if(min > 0 && max > 0 && (value < min || value > max))
         result = msg.outofrange;

      return result.replace(/%1/g, min).replace(/%2/g, max);
   }

   ,
	date: function() {
		this.value = toHalf(this.value);//半角変換
		if(!this.value.match(/^\d{4}\/\d{2}\/\d{2}$/))
			return this.msg.date;

	    var y = this.value.split("/")[0];
    	var m = this.value.split("/")[1] - 1;
    	var d = this.value.split("/")[2];
    	var date = new Date(y,m,d);
    	if(date.getFullYear() != y || date.getMonth() != m || date.getDate() != d)
    	    return this.msg.huseidate;
	}

};

Validator.lang = {
   ja: {
      noselect:   '\u9078\u629E\u304C\u5FC5\u8981\u3067\u3059\u3002',//選択が必要です。
      noinput:    '\u5165\u529B\u304C\u5FC5\u8981\u3067\u3059\u3002',//入力が必要です。
      unequal:    '\u5165\u529B\u304C\u63C3\u3063\u3066\u3044\u307E\u305B\u3093\u3002',//入力が揃っていません。

      submit:     '\u5165\u529B\u30A8\u30E9\u30FC\u304C\u3042\u308A\u307E\u3059\u3002',//入力エラーがあります。
      mail:       '\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002',//メールアドレスの形式が正しくありません。
      alphabet:   '半角英数で入力して下さい。',
      kana:       '\u5168\u89D2\u30AB\u30BF\u30AB\u30CA\u3067\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//全角カタカナで入力して下さい。
      zen:        '全角文字で入力して下さい。',

      count: {
         unequal:    '%1'+'\u6587\u5B57\u3067\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//"%1文字で入力して下さい。"
         too_big:    '%2'+'\u6587\u5B57\u4EE5\u5185\u3067\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//"%2文字以内で入力して下さい。"
         too_small:  '%1'+'\u6587\u5B57\u4EE5\u4E0A\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//"%1文字以上入力して下さい。"
         outofrange: '%1'+'\u304B\u3089'+'%2'+'\u6587\u5B57\u306E\u9593\u3067\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002'//"%1から%2文字の間で入力して下さい。"
      },

      num: {
         nonumber:   '\u6570\u5024\u3067\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//"数値で入力して下さい。"
         unequal:    '%1'+'\u3068\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//"%1以上の値を入力して下さい。"
         too_big:    '%2'+'\u4EE5\u4E0B\u306E\u5024\u3092\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//"%2以下の値を入力して下さい。"
         too_small:  '%1'+'\u4EE5\u4E0A\u306E\u5024\u3092\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002',//"%1以上の値を入力して下さい。"
         outofrange: '%1'+'\u304B\u3089'+'%2'+'\u306E\u9593\u3067\u5165\u529B\u3057\u3066\u4E0B\u3055\u3044\u3002'//"%1から%2の間で入力して下さい。"
      },

      check: {
         unequal:    '\u30C1\u30A7\u30C3\u30AF\u306F'+'%1'+'\u500B\u3057\u3066\u4E0B\u3055\u3044\u3002',//チェックは%1個して下さい。
         too_big:    '\u30C1\u30A7\u30C3\u30AF\u306F'+'%2'+'\u500B\u307E\u3067\u3067\u3059\u3002',//チェックは%2個までです。
         too_small:  '\u30C1\u30A7\u30C3\u30AF\u306F'+'%1'+'\u500B\u4EE5\u4E0A\u3057\u3066\u4E0B\u3055\u3044\u3002',//チェックは%1個以上して下さい。
         outofrange: '\u30C1\u30A7\u30C3\u30AF\u306F'+'%1'+'\u500B\u304B\u3089'+'%2'+'\u500B\u307E\u3067\u3067\u3059\u3002'//チェックは%1個から%2個までです。
      },

      date:          'yyyy/mm/dd形式で入力して下さい。',
	  huseidate:     '不正な日付です'
   }
};

Validator.rule.msg = Validator.lang.ja;


//半角を全角に変換
function toFull(value){
//console.log("全角変換前："+value);
	//英数記号
	value = value.replace(/[!-~]/g,function(c){return String.fromCharCode(c.charCodeAt(0)+0xFEE0);});
	//スペース
	value = value.replace(/ /g,"　");
//console.log("全角変換後："+value);
	return value;
};
//全角を半角に変換
function toHalf(value){
//console.log("半角変換前："+value);

	//英数記号
	value = value.replace(/[！-～]/g,function(c){return String.fromCharCode(c.charCodeAt(0)-0xFEE0);});
	//スペース
	value = value.replace(/　/g," ");
//console.log("半角変換後："+value);
	return value;
};
