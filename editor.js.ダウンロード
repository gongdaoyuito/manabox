/**
 * Copyright (c) 2013 NSD CO., LTD. All Rights Reserved.
 */

// エディタについて
// ・値登録時は、値を手動でコントロールにつめる。※時々入っていないため。
// ・値変更のチェックは自前で行う。※エディタのチェック機能がおかしいため。
// ・初期値は setHtml で行う(JSPでテキストエリアにいれない)。※なにか理由があったが忘れた。

var ORI_VAL_EDITOR = "";
var ORI_VAL_EDITOR_ARR = [];

var IS_DISABLE = false;

// エディタ初期化
function initEditor(kbn, idVal) {

	// 学習活動実施、参照
	// または評価登録
	// または学習活動登録の登録、更新以外
	// または学習活動登録の編集の実施済み生徒がいる(設問のみ編集不可)
	// またはモバイル版学習活動実施、参照
	// の場合はエディタ部分編集不可
	if (($("[name='viewId']").val() == 'StuGksKtdDialog.jsp' && editptn == "refer")
			|| ($("[name='viewId']").val() == 'HyokaTrkDialog.jsp')
			|| ($("[name='viewId']").val() == 'UpdJgKmk.jsp'
				&& ($("#editptn").val() != "insert" && $("#editptn").val() != "update"))
			|| ($("[name='viewId']").val() == 'UpdJgKmk.jsp' && !isSetumonEditable()
				&& (kbn == 'qInit' || kbn == 'qNew'))
			|| (($("[name='viewId']").val() == 'M_StuGksKtdDialog.jsp' && editptn == "refer"))) {
		IS_DISABLE = true;
	}

	if (IS_DISABLE) {
		if ($("[name='viewId']").val() == 'M_StuGksKtdDialog.jsp') {
			$('#editor_area_upd').remove();
			//参照用データ設定
			$("#" + idVal).html(EDIT_VAL);

		} else {
			// エディタ設定
			init_editer(kbn, idVal);
		}

	} else {
		if ($("[name='viewId']").val() == 'M_StuGksKtdDialog.jsp') {
			$('#editor_area_ref').remove();
		}
		// エディタ設定
		init_editer(kbn, idVal);
	}
}

//エディタ設定
function init_editer(kbn, idVal) {

	// ボタン情報
	var btnList = ['color', 'bold', 'underline', 'strikeThrough', 'fontSize'];

	// 画像UP機能
	var isUploadImg = false;
	// サイズ情報
	var widthVal = "";
	var heightVal = "";

	// 学習活動：提出
	if (kbn == 2) {
		widthVal = "950";
		heightVal = "";

		isUploadImg = true;
		btnList.unshift('insertImage');

	// ショーケース
	} else if (kbn == 's') {
		widthVal = "420";
		heightVal = "470";

	// 学習活動：概要
	} else if (kbn == 'g') {
		widthVal = "730";
		heightVal = "";

		isUploadImg = true;
		btnList.unshift('insertImage');
		btnList.push('createLink');

	// 学習活動：設問
	} else if (kbn == 'qNew' || kbn == 'qInit') {
		widthVal = "680";
		heightVal = "";

		isUploadImg = true;
		btnList.unshift('insertImage');
		btnList.push('createLink');

	// 全域通知お知らせ, 教員共有お知らせ
	} else if ( kbn == 'oshirase' ){

		widthVal = "705";
		heightVal = "200";

		btnList = ['color', 'bold', 'underline', 'strikeThrough'];
		btnList.push('createLink');
	}

//TODO mobileお試し
	if(mobileFlg){
		widthVal = "100%";
		//strikeThroughを消す
//		var delindex = btnList.indexOf('strikeThrough');
//		btnList.splice(delindex, 1);

	}

	// フォーマット削除ボタン
	btnList.push('removeFormat');

	// エディタ
	$('#' + idVal).editable({

		// エディタ設定
		inlineMode: false,
		width:widthVal,
		language: 'ja',
		placeholder: "",
		shortcuts: false,
		imageLink: false,
		plainPaste: true,
		alwaysBlank: true,
		allowedImageTypes: ["jpeg", "jpg", "png", "bmp", "gif"],

		pasteImage: false,
		pastedImagesUploadURL: '',

		// 画像アップロードURL
		imageUploadURL:serv + getUrlWithCSRFHash('/EditorServlet?', getForm()) + "&kbn=1",

		// 画像削除確認
		imageDeleteConfirmation: false,

		// メニュー
		buttons : btnList,

		// 画像アップ可非
		imageUpload:isUploadImg

	})

	// 画像アップロードエラー
	.on('editable.imageError', function (e, editor, error) {

		var msg = [];
		msg[1] = 'Bad link.';
		msg[2] = 'No link in upload response.';
		msg[3] = 'Error during image upload.';
		msg[4] = 'Parsing response failed.';
		msg[5] = 'Image too large.';
		msg[6] = 'Invalid image type.';
		msg[7] = 'Image can be uploaded only to same domain in IE 8 and IE 9.';

		alertDialog("画像アップロードに失敗しました。", errWinTitle, okBtnName);
		console.log(msg[error.code]);

	})

	// 画像アップロード前処理
	.on('editable.beforeImageUpload', function (e, editor, images) {
		// 画像アップロードチェック
		return imgUpChk(images);
  	})

	// 画像登録後
	.on('editable.imageInserted', function (e, editor, img) {
		$(img).addClass("editorImgLink");
	})

	// 画像削除処理
	.on('editable.afterRemoveImage', function (e, editor, $img) {
		if (!isAruCopyImg($img.attr('src'))) {
			doEditorImgDel($img.attr('src'));
		}

  	});

	if (kbn == 'qInit' || kbn == 'qNew') {

		// 初期値
		if (kbn == 'qInit'
			&& typeof EDIT_VAL_ARR[idVal] !== 'undefined' && EDIT_VAL_ARR[idVal] != '') {
			$("#" + idVal).editable("setHTML", EDIT_VAL_ARR[idVal], true);
		}

		// 変更確認用
		ORI_VAL_EDITOR_ARR[idVal] = $("#" + idVal).editable("getHTML", true, true);

	} else {
		// 初期値
		if (typeof EDIT_VAL !== 'undefined' && EDIT_VAL != '') {
			$("#" + idVal).editable("setHTML", EDIT_VAL, true);
		}

		// 変更確認用
		ORI_VAL_EDITOR = $("#" + idVal).editable("getHTML", true, true);

	}

	// エディタ高さ
	if (heightVal != '') {
		$('#' + idVal).editable('option', 'height', heightVal);
	}

	// 学習活動実施、参照
	// または評価登録
	// または学習活動登録の登録、更新以外
	// または学習活動登録の編集の実施済み生徒がいる(設問のみ編集不可)
	// の場合はエディタ部分編集不可
	if (IS_DISABLE) {
		$("#" + idVal).editable("disable");
	}

}

//画像リンク
$(function() {
	$(document).on('click', '.editorImgLink', function(){

		var srcUrl = $(this).attr("src");
		window.open(srcUrl,"_blank");
		return false;

	});
});

// コピー画像存在チェック
function isAruCopyImg(srcVal) {

	var ret = false;

	$("[id^='setumon_']").each(function() {

		var idVal = $(this).attr("id");
		var htmlVal = $("#" + idVal).editable("getHTML", true, true);

		if (htmlVal.indexOf(srcVal) >= 0) {
			ret = true;
			return false;
		}

	});

	return ret;

}

// エディタ初期化 設問
function initEditorArr(kbn, idVal) {

	$("[id^='" + idVal + "']").each(function() {
		var idVal = $(this).attr("id");
		initEditor(kbn, idVal);
	});

}

// 画像アップロードチェックy
function imgUpChk(images) {

	// エラーでfalseを返す
	if (images.length > 1) {
		alertDialog("画像は一つずつしかアップロードできません。", errWinTitle, okBtnName);
		return false;

	} else {
		var chkFile = images[0];
		var fileSize = Math.round(chkFile.size/1024);//キロバイト

		// 拡張子
		var extTmp = getExtention(chkFile.name);
		if (extTmp == '' || $.inArray(extTmp.toLowerCase(), IMG_EXT) < 0) {
			alertDialog('画像しかアップロードできません。', errWinTitle, okBtnName);
			return false;
		}

		// サイズ(10Mまで)
		if (fileSize > 10240) {
			alertDialog(chkFile.name + 'はサイズオーバーです(' + fileSize + 'KB)。', errWinTitle, okBtnName);
			return false;
		}

	}

}

// エディタの編集内容をコントロールにつめる
function setEditorToCtrl(editorId, ctrlNameText, ctrlNameHtml) {

	$("[name='" + ctrlNameText + "']").val($("#" + editorId).editable("getText"));
	$("[name='" + ctrlNameHtml + "']").val($("#" + editorId).editable("getHTML", true, true));

}

//エディタの編集内容をコントロールにつめる
function setEditorToCtrlArr(editorId, ctrlNameText, ctrlNameHtml) {

	var textVal = "";
	var htmlVal = "";
	var sepVal = getSepVal(editorId);

	$("[id^='" + editorId + "']").each(function() {

		var idVal = $(this).attr("id");

		textVal += $("#" + idVal).editable("getText") + sepVal;
		htmlVal += $("#" + idVal).editable("getHTML", true, true) + sepVal;

	});

	$("[name='" + ctrlNameText + "']").val(textVal);
	$("[name='" + ctrlNameHtml + "']").val(htmlVal);
	$("[name='arrSep']").val(sepVal);

}

// 区切り用文字を作成
function getSepVal(editorId) {

	var ret = "@" + Math.random().toString(36).slice(-8) + "@";

	var isFind = false;

	// 作成した値が使われていないか確認
	$("[id^='" + editorId + "']").each(function() {

		var idVal = $(this).attr("id");
		var tmpVal = $("#" + idVal).editable("getText");
		if (tmpVal.indexOf(ret) >= 0) {
			isFind = true;
			return false;
		}

	});

	// 作成した値が使われている場合は再帰処理
	if (isFind) {
		testcnt++;
		ret = getSepVal(editorId);
	}

	return ret;

}

//プレビュー判定
function isPreview() {

	var ret = false;

	if (typeof preview !== 'undefined' && preview) {
		ret = true;
	}

	return ret;

}

// 変更確認
function isEditorChg(idVal) {

	var ret = false;

	if (ORI_VAL_EDITOR != $("#" + idVal).editable("getHTML", true, true)) {
		ret = true;
	}

	return ret;

}

//変更確認
function isEditorChgArr(idTmp) {

	var ret = false;

	$("[id^='" + idTmp + "']").each(function() {
		var idVal = $(this).attr("id");
		if (typeof ORI_VAL_EDITOR_ARR[idVal] !== 'undefined'
			&& ORI_VAL_EDITOR_ARR[idVal] != $("#" + idVal).editable("getHTML", true, true)) {
			ret = true;
			return false;
		}
	});

	return ret;

}

// 編集時 画像削除
function doEditorImgDel(imgSrc) {

	$.ajax({
		url: serv + getUrlWithCSRFHash('/EditorServlet?', getForm()),
		type: 'POST',
		data: {kbn:"2", imgSrc:imgSrc},
		dataType: '',
		async : false,
		cache : false,
		success: function(data, dataType){}
	});

}

// 画面移動時 TMPクリア処理
function doEditorImgTmpClear() {

	// 編集画面以外は表示した画像をクリア
	var kbnVal = "3";
	if ($("[name='viewId']").val() != 'UpdJgKmk.jsp') {
		kbnVal = "4";
	}

	$.ajax({
		url: serv + getUrlWithCSRFHash('/EditorServlet?', getForm()),
		type: 'POST',
		data: {
			kbn:kbnVal
		},
		dataType: '',
		async : false,
		cache : false,
		success: function(data, dataType){}
	});

}

// 入力文字数確認
function isOverLen(idVal) {

	var ret = false;

	var inputLen = $("#" + idVal).editable("getText").length;
	var maxLen = $("#" + idVal).attr('maxlength');
	if (inputLen > maxLen) {
		ret = true;
	}

	return ret;

}
